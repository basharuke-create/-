<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Gemini Hyper Agent v6 ‚Äî Reasoning Mode</title>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --text: #c9d1d9; --accent: #238636; --error: #f85149; }
        body { background: var(--bg); color: var(--text); font-family: 'SFMono-Regular', Consolas, monospace; padding: 20px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; }
        input, textarea { width: 100%; background: #010409; color: #fff; border: 1px solid #30363d; padding: 12px; margin-bottom: 10px; border-radius: 6px; box-sizing: border-box; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; background: var(--accent); }
        #stopBtn { background: #da3633; }
        #output { background: #010409; padding: 20px; border-radius: 6px; height: 600px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; border: 1px solid #30363d; }
        .iteration { color: #8b949e; border-bottom: 1px solid #30363d; margin: 20px 0 10px; font-weight: bold; }
        .plan { color: #d2a8ff; } .exec { color: #79c0ff; } .critic { color: #ffa657; } .score { color: #f2cc60; background: rgba(242,204,96,0.1); padding: 2px 5px; }
        .error { color: var(--error); border: 1px solid var(--error); padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:#58a6ff;">üöÄ Gemini Hyper Agent v6</h2>
    <input type="password" id="apiKey" placeholder="Gemini API Key (AI Studio)">
    <textarea id="prompt" rows="3" placeholder="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ (ÊßãÈÄ†Âåñ„ÉªÊï∞ÂÄ§Âåñ„Éª4Ë¶ñÁÇπÂàÜÊûê„ÇíÂÆüË°å„Åó„Åæ„Åô)"></textarea>
    <div class="controls">
        <button id="runBtn">Ê∑±Â±§ÂàÜÊûêÈñãÂßã</button>
        <button id="stopBtn" style="display:none;">Á∑äÊÄ•ÂÅúÊ≠¢</button>
    </div>
    <div id="output"></div>
</div>

<script type="module">

class HyperAgent {
    constructor(apiKey) {
        this.apiKey = apiKey;
        this.model = "gemini-1.5-flash-latest"; 
        this.controller = null;
    }

    async callAPI(prompt, history, onChunk) {
        this.controller = new AbortController();
        // ‚òÖ‰øÆÊ≠£: ÊúÄ„ÇÇÂÆâÂÆö„Åô„Çã v1beta „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí‰ΩøÁî®
        const baseUrl = "https://generativelanguage.googleapis.com/v1beta/models/";
        const endpoint = `${this.model}:streamGenerateContent?key=${this.apiKey}`;
        const url = baseUrl + endpoint;

        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            signal: this.controller.signal,
            body: JSON.stringify({
                contents: history.concat([{ role: "user", parts: [{ text: prompt }] }]),
                generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Status ${response.status}: ${errorText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            // Ê≠£Ë¶èË°®Áèæ„Å´„Çà„ÇãÂ†ÖÁâ¢„Å™„ÉÜ„Ç≠„Çπ„ÉàÊäΩÂá∫
            const matches = chunk.matchAll(/"text":\s*"((?:[^"\\]|\\.)*)"/g);
            for (const match of matches) {
                let text = match[1]
                    .replace(/\\n/g, "\n")
                    .replace(/\\"/g, '"')
                    .replace(/\\\\/g, "\\");
                fullText += text;
                onChunk(text);
            }
        }
        return fullText;
    }
}

const runBtn = document.getElementById("runBtn");
const stopBtn = document.getElementById("stopBtn");
const outputEl = document.getElementById("output");

function log(text, type) {
    const span = document.createElement("span");
    if (type) span.className = type;
    span.textContent = text;
    outputEl.appendChild(span);
    outputEl.scrollTop = outputEl.scrollHeight;
}

runBtn.addEventListener("click", async () => {
    const key = document.getElementById("apiKey").value.trim();
    const task = document.getElementById("prompt").value.trim();
    if (!key || !task) return alert("API„Ç≠„Éº„Å®„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");

    runBtn.disabled = true;
    stopBtn.style.display = "inline";
    outputEl.textContent = ">>> Agent Engine Initializing...\n";

    const agent = new HyperAgent(key);
    let history = [];
    let bestResult = "";
    let bestScore = 0;

    try {
        for (let i = 1; i <= 3; i++) {
            log(`\n\n[ITERATION ${i} ‚Äî Self-Refining]`, "iteration");

            // PHASE 1: STRATEGIC PLANNING
            log("\n[1/3: PLANNING] ", "plan");
            const planPrompt = `Task: ${task}\n„ÄêÂëΩ‰ª§„ÄëÊà¶Áï•„ÉªË≤°Âãô„Éª„É™„Çπ„ÇØ„ÉªÂøÉÁêÜ„ÅÆ4Ë¶ñÁÇπ„ÇíÂê´„ÇÄÂÆüË°åË®àÁîª„Çí4„Çπ„ÉÜ„ÉÉ„Éó„ÅßÁ≠ñÂÆö„Åõ„Çà„ÄÇ`;
            const plan = await agent.callAPI(planPrompt, history, (t) => log(t, "plan"));

            // PHASE 2: EXECUTION
            log("\n\n[2/3: EXECUTING] ", "exec");
            const execPrompt = `Plan: ${plan}\n„ÄêÂëΩ‰ª§„ÄëË®àÁîª„ÇíÂÆüË°å„Åõ„Çà„ÄÇÂõûÁ≠î„ÅØÂøÖ„ÅöÊßãÈÄ†Âåñ„ÉªÊï∞ÂÄ§Âåñ„Åó„ÄÅÊàêÂäüÁ¢∫Áéá„Å®ÂèçË®ºÔºàÂèçÂØæÊÑèË¶ãÔºâ„ÇíÊòéË®ò„Åõ„Çà„ÄÇÊõñÊòßË°®Áèæ„ÅØÂé≥Á¶Å„ÄÇ`;
            const result = await agent.callAPI(execPrompt, history, (t) => log(t, "exec"));

            // PHASE 3: CRITICAL ANALYSIS
            log("\n\n[3/3: CRITIQUE] ", "critic");
            const criticPrompt = `Result: ${result}\n„ÄêÂëΩ‰ª§„Äë‰∏äË®ò„ÇíÂé≥Ê†º„Å´Êé°ÁÇπ„Åõ„Çà(0-100)„ÄÇÂΩ¢Âºè: SCORE: [Êï∞ÂÄ§] / REASON: [ÁêÜÁî±]`;
            const critic = await agent.callAPI(criticPrompt, history, (t) => log(t, "critic"));

            const score = parseInt(critic.match(/SCORE:\s*(\d+)/)?.[1] || "0");
            log(`\n>> SCORE: ${score}`, "score");

            if (score > bestScore) { bestScore = score; bestResult = result; }
            if (score >= 90) break;

            history.push({ role: "user", parts: [{ text: `ÊîπÂñÑÁÇπ: ${critic}` }] });
            history.push({ role: "model", parts: [{ text: "‰∫ÜËß£„ÄÇÊ¨°Âõû„ÅÆË©¶Ë°å„Å´ÂèçÊò†„Åô„Çã„ÄÇ" }] });
        }
        log(`\n\nüèÜ FINAL STRATEGIC OUTPUT (Best Score: ${bestScore})\n\n${bestResult}`, "exec");
    } catch (e) {
        log(`\n\n[FATAL ERROR] ${e.message}`, "error");
    } finally {
        runBtn.disabled = false;
        stopBtn.style.display = "none";
    }
});

stopBtn.addEventListener("click", () => location.reload());

</script>
</body>
</html>
