<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Gemini Hyper Agent v7</title>
    <style>
        :root { --bg: #0d1117; --text: #c9d1d9; --accent: #238636; }
        body { background: var(--bg); color: var(--text); font-family: monospace; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        input, textarea { width: 100%; background: #010409; color: #fff; border: 1px solid #30363d; padding: 12px; margin-bottom: 10px; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; background: var(--accent); }
        #output { background: #000; padding: 20px; border-radius: 6px; height: 600px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; border: 1px solid #30363d; margin-top: 20px; }
        .plan { color: #d2a8ff; } .exec { color: #79c0ff; } .critic { color: #ffa657; } .score { color: #f2cc60; font-weight: bold; }
        .error { color: #f85149; border: 1px solid #f85149; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:#58a6ff;">ğŸš€ Gemini Hyper Agent v7</h2>
    <input type="password" id="apiKey" placeholder="Gemini API Key">
    <textarea id="prompt" rows="3" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›"></textarea>
    <button id="runBtn">æ·±å±¤åˆ†æé–‹å§‹</button>
    <div id="output"></div>
</div>

<script type="module">

class FinalAgent {
    constructor(apiKey) {
        this.apiKey = apiKey;
        // â˜…ä¿®æ­£: ã‚¹ã‚¯ã‚·ãƒ§ã®ã‚¨ãƒ©ãƒ¼ã«åŸºã¥ãã€ãƒ¢ãƒ‡ãƒ«åã‚’å›ºå®šç‰ˆã«å¤‰æ›´
        this.model = "gemini-1.5-flash"; 
    }

    async callAPI(prompt, history, onChunk) {
        // â˜…ä¿®æ­£: v1beta ã¨ gemini-1.5-flash ã®çµ„ã¿åˆã‚ã›ã‚’å›ºå®š
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.model}:streamGenerateContent?key=${this.apiKey}`;

        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: history.concat([{ role: "user", parts: [{ text: prompt }] }]),
                generationConfig: { temperature: 0.3 }
            })
        });

        if (!response.ok) {
            const err = await response.text();
            throw new Error(`API Error: ${response.status}\n${err}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            
            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹æœ€ã‚‚å …ç‰¢ãªæ­£è¦è¡¨ç¾
            const matches = chunk.matchAll(/"text":\s*"((?:[^"\\]|\\.)*)"/g);
            for (const match of matches) {
                let text = match[1].replace(/\\n/g, "\n").replace(/\\"/g, '"').replace(/\\\\/g, "\\");
                onChunk(text);
            }
        }
    }
}

const runBtn = document.getElementById("runBtn");
const outputEl = document.getElementById("output");

function log(text, type) {
    const span = document.createElement("span");
    if (type) span.className = type;
    span.textContent = text;
    outputEl.appendChild(span);
    outputEl.scrollTop = outputEl.scrollHeight;
}

runBtn.addEventListener("click", async () => {
    const key = document.getElementById("apiKey").value.trim();
    const task = document.getElementById("prompt").value.trim();
    if (!key || !task) return alert("å…¥åŠ›ä¸è¶³");

    outputEl.textContent = ">>> Agent v7 Starting...\n";
    const agent = new FinalAgent(key);
    let history = [];

    try {
        for (let i = 1; i <= 2; i++) {
            log(`\n\n[è©¦è¡Œ ${i}]`, "score");

            log("\n[è¨ˆç”»] ", "plan");
            const plan = await agent.callAPI(`Task: ${task}\nå‘½ä»¤: æˆ¦ç•¥ãƒ»è²¡å‹™ãƒ»ãƒªã‚¹ã‚¯ãƒ»å¿ƒç†ã®4è¦–ç‚¹ã§è¨ˆç”»ã‚’ç«‹ã¦ã‚ã€‚`, history, (t) => log(t, "plan"));

            log("\n\n[å®Ÿè¡Œ] ", "exec");
            const result = await agent.callAPI(`Plan: ${plan}\nå‘½ä»¤: æ§‹é€ åŒ–ãƒ»æ•°å€¤åŒ–ã—ã€åè¨¼ã‚‚å«ã‚ã¦å‡ºåŠ›ã›ã‚ˆã€‚`, history, (t) => log(t, "exec"));

            log("\n\n[è©•ä¾¡] ", "critic");
            const critic = await agent.callAPI(`Result: ${result}\nå‘½ä»¤: 100ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã›ã‚ˆã€‚SCORE: [æ•°å€¤]`, history, (t) => log(t, "critic"));

            const score = parseInt(critic.match(/SCORE:\s*(\d+)/)?.[1] || "0");
            if (score >= 85) break;
            history.push({ role: "user", parts: [{ text: `æ”¹å–„ç‚¹: ${critic}` }] });
        }
        log("\n\nâœ… åˆ†æå®Œäº†ã€‚", "score");
    } catch (e) {
        log(`\n\n[FATAL ERROR]\n${e.message}`, "error");
    }
});
</script>
</body>
</html>
