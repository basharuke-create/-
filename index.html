<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Gemini Hyper Agent v8 â€” Final Stable</title>
    <style>
        :root { --bg: #0d1117; --text: #c9d1d9; --accent: #238636; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        input, textarea { width: 100%; background: #010409; color: #fff; border: 1px solid #30363d; padding: 12px; margin-bottom: 10px; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; background: var(--accent); }
        #output { background: #000; padding: 20px; border-radius: 6px; height: 600px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; border: 1px solid #30363d; margin-top: 20px; }
        .plan { color: #d2a8ff; } .exec { color: #79c0ff; } .critic { color: #ffa657; } .score { color: #f2cc60; font-weight: bold; }
        .error { color: #f85149; background: rgba(248,81,73,0.1); padding: 15px; border-radius: 6px; border: 1px solid #f85149; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:#58a6ff;">ğŸš€ Gemini Hyper Agent v8</h2>
    <input type="password" id="apiKey" placeholder="Gemini API Key">
    <textarea id="prompt" rows="3" placeholder="åˆ†æã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
    <button id="runBtn">æˆ¦ç•¥ãƒ»è²¡å‹™ãƒ»ãƒªã‚¹ã‚¯ãƒ»å¿ƒç† 4è¦–ç‚¹åˆ†æé–‹å§‹</button>
    <div id="output"></div>
</div>

<script type="module">

class StableAgent {
    constructor(apiKey) {
        this.apiKey = apiKey;
        this.model = "gemini-1.5-flash"; 
    }

    async callAPI(prompt, history, onUpdate) {
        // â˜…ä¿®æ­£ï¼šæœ€ã‚‚å®‰å®šã™ã‚‹ v1 ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®é€šå¸¸ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
        const url = `https://generativelanguage.googleapis.com/v1/models/${this.model}:generateContent?key=${this.apiKey}`;

        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: history.concat([{ role: "user", parts: [{ text: prompt }] }]),
                generationConfig: { 
                    temperature: 0.2,
                    maxOutputTokens: 2048
                }
            })
        });

        if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            throw new Error(`[Status ${response.status}] ${errData.error?.message || "Unknown API Error"}`);
        }

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "å¿œç­”ãªã—";
        onUpdate(text);
        return text;
    }
}

const runBtn = document.getElementById("runBtn");
const outputEl = document.getElementById("output");

function log(text, type) {
    const div = document.createElement("div");
    if (type) div.className = type;
    div.textContent = text;
    outputEl.appendChild(div);
    outputEl.scrollTop = outputEl.scrollHeight;
}

runBtn.addEventListener("click", async () => {
    const key = document.getElementById("apiKey").value.trim();
    const task = document.getElementById("prompt").value.trim();
    if (!key || !task) return alert("å…¥åŠ›ãŒå¿…è¦ã§ã™");

    runBtn.disabled = true;
    outputEl.textContent = ">>> ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­... å®‰å®šç‰ˆ v1 é€šä¿¡ç¢ºç«‹ã‚’è©¦ã¿ã¾ã™ã€‚\n";
    
    const agent = new StableAgent(key);
    let history = [];

    try {
        for (let i = 1; i <= 2; i++) {
            log(`\n\n=== è©¦è¡Œå›æ•°: ${i} ===`, "score");

            // STEP 1: PLAN
            log("\n[è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚º] åˆ†æä¸­...", "plan");
            const plan = await agent.callAPI(
                `Task: ${task}\nå‘½ä»¤: æˆ¦ç•¥ãƒ»è²¡å‹™ãƒ»ãƒªã‚¹ã‚¯ãƒ»å¿ƒç†ã®4è¦–ç‚¹ã§ã€æ§‹é€ åŒ–ã•ã‚ŒãŸå®Ÿè¡Œè¨ˆç”»ã‚’ç«‹ã¦ã‚ã€‚`,
                history, (t) => { log(t, "plan"); }
            );

            // STEP 2: EXECUTE
            log("\n\n[å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º] è©³ç´°å‡ºåŠ›ä¸­...", "exec");
            const result = await agent.callAPI(
                `è¨ˆç”»: ${plan}\nå‘½ä»¤: ä¸Šè¨˜ã‚’å…·ä½“åŒ–ã›ã‚ˆã€‚å¿…ãšæ•°å€¤ã€æˆåŠŸç¢ºç‡ã€åè¨¼ã€ã‚¹ãƒ†ãƒƒãƒ—åˆ¥å®Ÿè¡Œæ‰‹é †ã‚’å«ã‚ã‚‹ã“ã¨ã€‚`,
                history, (t) => { log(t, "exec"); }
            );

            // STEP 3: CRITIC
            log("\n\n[è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚º] æ¤œè¨¼ä¸­...", "critic");
            const critic = await agent.callAPI(
                `çµæœ: ${result}\nå‘½ä»¤: 100ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã—æ”¹å–„ç‚¹ã‚’å‡ºã›ã€‚å½¢å¼: SCORE: [æ•°å€¤] / REASON: [ç†ç”±]`,
                history, (t) => { log(t, "critic"); }
            );

            const score = parseInt(critic.match(/SCORE:\s*(\d+)/)?.[1] || "0");
            if (score >= 85) break;
            
            history.push({ role: "user", parts: [{ text: `æ”¹å–„è¦æ±‚: ${critic}` }] });
            history.push({ role: "model", parts: [{ text: "äº†è§£ã€‚æ”¹å–„å†…å®¹ã‚’åæ˜ ã—ã¾ã™ã€‚" }] });
        }
        log("\n\nâœ… å…¨å·¥ç¨‹å®Œäº†ã€‚åˆ†æçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "score");
    } catch (e) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = `ã€è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã€‘\n${e.message}\n\nâ€»APIã‚­ãƒ¼ãŒæœ‰åŠ¹ã‹ã€Google AI Studioã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
        outputEl.appendChild(errorDiv);
    } finally {
        runBtn.disabled = false;
    }
});
</script>
</body>
</html>
