<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Gemini Hyper Agent v5 â€” Reasoning & Self-Refine</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #007acc; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        input, textarea { width: 100%; background: #2d2d2d; color: #fff; border: 1px solid #444; padding: 12px; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; background: var(--accent); }
        #stopBtn { background: #cc0000; display: none; }
        #output { background: #000; padding: 20px; border-radius: 8px; height: 600px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; border-left: 5px solid var(--accent); }
        .plan { color: #ce9178; } .exec { color: #9cdcfe; } .critic { color: #b5cea8; } .score { color: #ffd700; font-weight: bold; }
        .error { color: #ff5555; background: rgba(255,0,0,0.1); padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ Gemini Hyper Agent v5</h2>
    <input type="password" id="apiKey" placeholder="Gemini API Key">
    <textarea id="prompt" rows="3" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ› (ä¾‹: 2026å¹´ã®AIãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è²¡å‹™ãƒ»æˆ¦ç•¥è¦–ç‚¹ã§åˆ†æ)"></textarea>
    <div class="controls">
        <button id="runBtn">åˆ†æé–‹å§‹</button>
        <button id="stopBtn">åœæ­¢</button>
    </div>
    <div id="output"></div>
</div>

<script type="module">

class StableAgent {
    constructor(apiKey) {
        this.apiKey = apiKey;
        this.model = "gemini-1.5-flash"; // å®‰å®šã®Flashãƒ¢ãƒ‡ãƒ«
        this.controller = null;
    }

    async call(prompt, history, onChunk) {
        this.controller = new AbortController();
        // â˜…ä¿®æ­£: v1beta ã«æˆ»ã—ã€URLæœ«å°¾ã® :streamGenerateContent ã‚’ç¢ºå®š
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.model}:streamGenerateContent?key=${this.apiKey}`;

        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            signal: this.controller.signal,
            body: JSON.stringify({
                contents: history.concat([{ parts: [{ text: prompt }] }]),
                generationConfig: { temperature: 0.2, maxOutputTokens: 2500 }
            })
        });

        if (!response.ok) {
            const errJson = await response.json().catch(() => ({}));
            throw new Error(`HTTP ${response.status}: ${errJson.error?.message || "Unknown Error"}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            // Geminiã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã¯ "text": "..." ã‚’å«ã‚€JSONæ–­ç‰‡ãŒé€ã‚‰ã‚Œã¦ãã‚‹
            const lines = chunk.split("\n");
            for (const line of lines) {
                if (line.includes('"text":')) {
                    try {
                        const match = line.match(/"text":\s*"(.*)"/);
                        if (match) {
                            let text = match[1]
                                .replace(/\\n/g, "\n")
                                .replace(/\\"/g, '"')
                                .replace(/\\\\/g, "\\");
                            fullText += text;
                            onChunk(text);
                        }
                    } catch (e) {}
                }
            }
        }
        return fullText;
    }
}

const runBtn = document.getElementById("runBtn");
const stopBtn = document.getElementById("stopBtn");
const outputEl = document.getElementById("output");

function write(text, className) {
    const span = document.createElement("span");
    if (className) span.className = className;
    span.textContent = text;
    outputEl.appendChild(span);
    outputEl.scrollTop = outputEl.scrollHeight;
}

runBtn.addEventListener("click", async () => {
    const key = document.getElementById("apiKey").value.trim();
    const task = document.getElementById("prompt").value.trim();
    if (!key || !task) return alert("APIã‚­ãƒ¼ã¨ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    runBtn.disabled = true;
    stopBtn.style.display = "inline";
    outputEl.textContent = "Agent Initializing...\n";

    const agent = new StableAgent(key);
    let history = [];
    let bestScore = 0;
    let feedback = "æ§‹é€ åŒ–ãƒ»æ•°å€¤åŒ–ãƒ»4è¦–ç‚¹åˆ†æ(æˆ¦ç•¥,è²¡å‹™,ãƒªã‚¹ã‚¯,å¿ƒç†)ã‚’å¾¹åº•ã›ã‚ˆã€‚";

    try {
        for (let i = 1; i <= 3; i++) {
            write(`\n\n=== ITERATION ${i} ===\n`, "score");

            // PLAN
            write("\n[PLANNING]\n", "plan");
            const plan = await agent.call(`Task: ${task}\nFeedback: ${feedback}\n4è¦–ç‚¹(æˆ¦ç•¥,è²¡å‹™,ãƒªã‚¹ã‚¯,å¿ƒç†)ã§è¨ˆç”»ã‚’ç«‹ã¦ã‚ã€‚`, history, (t) => write(t, "plan"));

            // EXECUTE
            write("\n\n[EXECUTING]\n", "exec");
            const res = await agent.call(`Plan: ${plan}\nå…·ä½“ä¾‹ãƒ»æ•°å€¤ãƒ»æˆåŠŸç¢ºç‡ãƒ»åè¨¼ã‚’å«ã‚ã¦å®Ÿè¡Œã›ã‚ˆã€‚`, history, (t) => write(t, "exec"));

            // CRITIC
            write("\n\n[CRITIQUE]\n", "critic");
            const critic = await agent.call(`Result: ${res}\n100ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã— SCORE: [æ•°å€¤] å½¢å¼ã§å‡ºã›ã€‚`, history, (t) => write(t, "critic"));

            const score = parseInt(critic.match(/SCORE:\s*(\d+)/)?.[1] || "0");
            if (score >= 90) break;
            
            feedback = critic;
            history.push({ role: "user", parts: [{ text: `æ”¹å–„æ¡ˆ: ${critic}` }] });
        }
    } catch (e) {
        write(`\n\n[ERROR] ${e.message}`, "error");
    } finally {
        runBtn.disabled = false;
        stopBtn.style.display = "none";
    }
});

stopBtn.addEventListener("click", () => location.reload()); // ç°¡æ˜“åœæ­¢

</script>
</body>
</html>
